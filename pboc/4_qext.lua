package.path = package.path..string.format(";%s\\lib\\?.lua", __DIR__)..string.format(";%s\\config\\?.lua", __DIR__)

require("pboc_lib")
require("pboc_config")

--AID = "A0000003330101";
--AID = "A000000632010106";

Reset();
selectPPSE();
selectPBOC();
Send('80CA 9F79 00',"9000");
--sfi = 0x19
local data1 = '2701 30 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000';
local data2 = '2702 30 000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000';
local data3 = '2701 30 100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001';
local data4 = '2702 30 110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001';
local data5 = '2702 30 111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001';
local updatekey = 'C53D1584627665F46917FBB206230574';
AppendRecord('04E2 00C8 11'..updatekey..data1, '191A5F026001DF259A03019C37049F11');
AppendRecord('04E2 00C8 11'..updatekey..data2, '191A5F026001DF259A03019C37049F11');


--section purchase
Reset();
selectPPSE();
selectPBOC();
Send('80B4 00C8 02 2701',"9000");
TAG9F66 = "A6000000";
TAGDF60 = "01";
GPO_NoReadAFL();
Updata_CAPP_Data_Cache('84DE00C8 11'..data3, updatekey);
ReadAFL(TAG94);


--offline pre-authorization
Reset();
selectPPSE();
selectPBOC();
Send('80CA 9F79 00',"9000");
Send('80B4 00C8 02 2701',"9000");
Send('80B4 00C8 02 2702',"9000");
TAGDF60 = "02";
GPO_NoReadAFL();
Updata_CAPP_Data_Cache('84DE00C8 11'..data4, updatekey);
ReadAFL(TAG94);

--offline pre-authorization completion
Reset();
selectPPSE();
selectPBOC();
Send('80CA 9F79 00',"9000");
Send('80B4 00C8 02 2701',"9000");
Send('80B4 00C8 02 2702',"9000");
TAGDF60 = "03";
GPO_NoReadAFL();
Updata_CAPP_Data_Cache('84DE00C8 11'..data5, updatekey);
ReadAFL(TAG94);



Reset();
selectPPSE();
selectPBOC();
Send('80CA 9F79 00',"9000");
Send('80B4 00C8 02 2701',"9000");
Send('80B4 00C8 02 2702',"9000");